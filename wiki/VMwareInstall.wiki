#summary running a server production instance

<wiki:toc max_depth="6" />

= static IP, network bridge, iptables =

[http://code.google.com/p/xenia/wiki/XeniaUpdates#Additional_server_notes_-_static_IP,_network_bridge,_iptables original documentation]

Wanted to bridge the 'virtual' vmware player server across the 'host' server.  Established my static IP on the host using the following steps.

For the 'virtual' server on the vmplayer menu at screen top, changed the 'Devices->Network Adapter' setting to 'Bridged' which establishes network communication between the virtual server and host.

You may also need to set the radio button 'wired network' from the top menu icon(circled in red) in the following image

<img src="http://xenia.googlecode.com/files/screen_1.jpg" height=300 width=600>

The 'ifconfig' command will tell you which ethernet device the server is trying to communicate on.  For mine the host server was running 'eth0' and the virtual was running 'eth5'

from http://forums.techarena.in/operating-systems/1106661.htm

for the host the static IP is 129.252.37.90 

In host file /etc/networking/interfaces
{{{
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 129.252.37.90
netmask 255.255.255.0
gateway 192.252.37.1
}}}

Then restart network with 
{{{
sudo /etc/init.d/networking restart
}}}

Running 'ifconfig' command from virtual host listed ethernet as 'eth5' which is substituted for the 'eth0' and run in the same steps listed above for configuring the static IP for the host except now on the virtual server.

I did not have to modify the defaulted dns file settings for host or virtual server files under /etc/resolv.conf 

----

With the network 'bridge' setting in the vmware player, any ports on the virtual server are bridged over the host server (use 'nmap' command to see open ports).  So with the gisvm image opened on the vmplayer I was able to see the apache web server sample webpage running on port 80 and J2EE/tomcat server sample webpage running on port 8080 from other machines.

Currently only have port 80 open to machines outside the university network and wanted to show the geoserver demo applications running on port 8080 so used the following iptables commands (on the virtual server) to port forward 80 to 8080.

from http://www.klawitter.de/tomcat80.html
{{{
iptables -t nat -A OUTPUT -d localhost -p tcp --dport 80 -j REDIRECT --to-ports 8080
iptables -t nat -A OUTPUT -d 129.252.37.90 -p tcp --dport 80 -j REDIRECT --to-ports 8080
iptables -t nat -A PREROUTING -d 129.252.37.90 -p tcp --dport 80 -j REDIRECT --to-ports 8080
}}}

= openssh =

The initial image runs an openssh daemon which accepts no outside connects via the /etc/hosts.allow file below.  Modify the hosts.allow,hosts.deny files as necessary for access/security purposes.

file /etc/hosts.allow
{{{
#uncomment below line and add substitute your http ip below for ssh access
#sshd : xxx.xxx.xxx.xxx : allow
sshd : ALL : deny
}}}

= image default users, passwords =

The username associated with the xenia development is *xeniaprod* with password *xeniaprod999*  Modify this password as needed.

The username *user* has password *user999* although this user account is not utilized.  Modify this password as needed.

See the other gisvm related passwords [http://www.vmware.com/appliances/directory/55606 here] and modify as needed.

= host substitutions, configuration =

If you plan to run a production xenia vmware instance accessible by others on the web, search the xeniaprod code from the following directory to see the necessary localhost substitutions(for your production machine http address) or other configuration options.

{{{
cd /home/xeniaprod
find . -name "*" -exec grep -H "VM_CONFIG" {} \; 
find . -name "*.sh" -exec grep -H "localhost" {} \; 
find . -name "*.pl" -exec grep -H "localhost" {} \;  
find . -name "*.xml" -exec grep -H "localhost" {} \;
}}}

= postgresql or sqlite = 

The latest version of the vmware image is configured to utilize a postgresql/postgis relational database while the earlier version utilized a sqlite file-based relational database.

These changes are reflected in the xeniaprod crontab with xeniaflow_postgresql.sh directing the aggregation and product generation towards the /home/xeniaprod/scripts/postgresql branch instead of the /home/xeniaprod/scripts/sqlite one.

Similarly the symbolic links(time_series, sos) under /var/www/xenia are linked to postgresql branch instead of sqlite one.

= miscellaneous =

*sudo* all commands that need root access.

To sudo between users, use the first user password(user999 in the below example) not the target user password
{{{
user@gisvm:~$ sudo su - xeniaprod
[sudo] password for user:
xeniaprod@gisvm:~$ 
}}}

The *two crontabs* which are active are *root* which performs a nightly cleanup of files under directory /home/xeniaprod/tmp_web and *xeniaprod* which also performs file cleanup but more importantly runs the following main job hourly.

The file */home/xeniaprod/cron/xeniaflow.sh* creates all the subsequent related products and should be referenced to understand the product creation flow.

Xenia related log files are at /home/xeniaprod/tmp and cleared nightly.

Apache user(www-data) created related temporary files are at /home/xeniaprod/tmp_web and cleared nightly.

----
= VMware Server =

Successfully installed VMware Server 2.0.1 on Ubuntu 8.10 

The vmware server is installed via the vmware-install.pl script and starts the services at the end of a successful install.  The vmware server maintenance ui is accessed via browser at http://localhost:8222 or secure port https://localhost:8333

== Problems, workarounds ==

Had a compile error on 'vmsock' but the install said this was not critical to the usual processes.  Not having it compiled does not seem to create any noticeable issue.

One problem I ran into was that VMware server configured vmnet0 (only shows up in the process list 'ps -auxf' not via 'ifconfig' command) to eth0 and eth0 was not bridging ('x' symbol in the server maintenance ui).  Switched vmnet0 over to eth1 via the {{{/usr/bin/vmware-config.pl}}} script which did bridge correctly.

Per each virtual image instance/IP address as configured in the file /etc/network/interfaces, make sure to set your ethx (eth7,eth8,etc)  connection correctly the same as found in the 'ifconfig' listing  setting and restart via {{{/etc/init.d/networking restart}}}  The correct image IP listing should also show up in the vmware server maintenance ui.

vmware images can be referenced on the host machine vmware ui by placing or symbolically linking via the /var/lib/vmware/Virtual Machines folder

Saw some notes regarding ethernet optimization/mishandling issues such as to run the command {{{ethtool -K eth1 sg off rx off tx off tso off}}} but did not utilize this command.