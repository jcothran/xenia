#summary running a server production instance

<wiki:toc max_depth="6" />

= Setup =

== network bridge ==

*note - network bridge(this section instruction) only utilized for vmware player and server, not vmware ESXi *

[http://code.google.com/p/xenia/wiki/XeniaUpdates#Additional_server_notes_-_static_IP,_network_bridge,_iptables original documentation]

Wanted to bridge the 'virtual' vmware player server across the 'host' server.  Established my static IP on the host using the following steps.

For the 'virtual' server on the vmplayer menu at screen top, changed the 'Devices->Network Adapter' setting to 'Bridged' which establishes network communication between the virtual server and host.

You may also need to set the radio button 'wired network' from the top menu icon(circled in red) in the following image

<img src="http://xenia.googlecode.com/files/screen_1.jpg" height=300 width=600>

== static ip ==

The {{{ifconfig}}} command will tell you which ethernet device the server is trying to communicate on({{{ifconfig -a}}} will show all available devices).  For mine the host server was running 'eth0' and the virtual was running 'eth5'

from http://forums.techarena.in/operating-systems/1106661.htm

for the host the static IP is 129.252.37.90 

In host file /etc/network/interfaces
{{{
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address 129.252.37.90
netmask 255.255.255.0
gateway 192.252.37.1
}}}

Then restart network with 
{{{
sudo /etc/init.d/networking restart
}}}

Running 'ifconfig' command from virtual host listed ethernet as 'eth5' which is substituted for the 'eth0' and run in the same steps listed above for configuring the static IP for the host except now on the virtual server.

I did not have to modify the defaulted dns file settings for host or virtual server files under /etc/resolv.conf 

----

== iptables ==

*note - this section on iptables can be skipped*

With the network 'bridge' setting in the vmware player, any ports on the virtual server are bridged over the host server (use 'nmap' command to see open ports).  So with the gisvm image opened on the vmplayer I was able to see the apache web server sample webpage running on port 80 and J2EE/tomcat server sample webpage running on port 8080 from other machines.

Currently only have port 80 open to machines outside the university network and wanted to show the geoserver demo applications running on port 8080 so used the following iptables commands (on the virtual server) to port forward 80 to 8080.

from http://www.klawitter.de/tomcat80.html
{{{
iptables -t nat -A OUTPUT -d localhost -p tcp --dport 80 -j REDIRECT --to-ports 8080
iptables -t nat -A OUTPUT -d 129.252.37.90 -p tcp --dport 80 -j REDIRECT --to-ports 8080
iptables -t nat -A PREROUTING -d 129.252.37.90 -p tcp --dport 80 -j REDIRECT --to-ports 8080
}}}

== openssh ==

The initial image runs an openssh daemon which accepts no outside connects via the /etc/hosts.allow file below.  Modify the hosts.allow,hosts.deny files as necessary for access/security purposes.

file /etc/hosts.allow
{{{
#uncomment below line and add substitute your http ip below for ssh access
#sshd : xxx.xxx.xxx.xxx : allow
sshd : ALL : deny
}}}

== image default users, passwords ==

#reset user passwds to public defaults - user,root,xeniaprod,postgres - as root, passwd <username>

The *root* user has password *root99*.  Modify this password as needed.

The *postgres* user has password *postgres99*.  Modify this password as needed.

The username associated with the xenia development is *xeniaprod* with password *xeniaprod99*  Modify this password as needed.

The username *user* has password *user99* although this user account is not utilized.  Modify this password as needed.

Both users *xeniaprod* and *user* are part of the *admin* group ({{{sudo vi /etc/group}}}) which is a 'sudo' ({{{sudo vi /etc/sudoers}}}) enabled group.

See the other gisvm related passwords [http://www.vmware.com/appliances/directory/55606 here] and modify as needed.

== host substitutions, configuration ==

If you plan to run a production xenia vmware instance accessible by others on the web, search the xeniaprod code from the following directory to see the necessary localhost substitutions(for your production machine http address) or other configuration options.

see also http://code.google.com/p/xenia/wiki/VMwareDesign#Checklist

{{{
cd /home/xeniaprod
find . -name "*" -exec grep -H "VM_CONFIG" {} \; 
find . -name "*.sh" -exec grep -H "129.252.37.90" {} \; 
find . -name "*.pl" -exec grep -H "129.252.37.90" {} \;  
find . -name "*.xml" -exec grep -H "129.252.37.90" {} \;
}}}

{{{
search for #VM_CONFIG in effected files

/etc/hosts.allow  #ssh ip access

=
#postgres
optional - database size on /usr2, delete old records - vacuum

user passwds - postgres,xeniaprod
psql -U postgres -h xxx.xxx.xxx.xxx
alter user postgres with password 'xxx';
alter user xeniaprod with password 'xxx';

#enable #VM_CONFIG ip addresses
sudo vi /usr2/pg_data/pg_hba.conf

cd /home/xeniaprod/config #database user/password
  dbConfig.ini
  environment_xenia_default.xml

#enable feeds as needed
/home/xeniaprod/cron/getObskml.sh
/home/xeniaprod/cron/mk_xenia_all_latest.sh

search for #VM_CONFIG in effected crons (crontab -e)
#start crons - root, xeniaprod

check output graphs(.png) under http://xxx.xxx.xxx.xxx/xenia/feeds after a few hours to verify feed processing/population

}}}

== postgresql or sqlite == 

The latest version of the vmware image is configured to utilize a postgresql/postgis relational database while the earlier version utilized a sqlite file-based relational database.

These changes are reflected in the xeniaprod crontab with xeniaflow_postgresql.sh directing the aggregation and product generation towards the /home/xeniaprod/scripts/postgresql branch instead of the /home/xeniaprod/scripts/sqlite one.

Similarly the symbolic links(time_series, sos) under /var/www/xenia are linked to postgresql branch instead of sqlite one.

== miscellaneous ==

*sudo* all commands that need root access.

To sudo between users, use the first user password(user99 in the below example) not the target user password
{{{
user@gisvm:~$ sudo su - xeniaprod
[sudo] password for user:
xeniaprod@gisvm:~$ 
}}}

The *two crontabs* which are active are *root* which performs a nightly cleanup of files under directory /home/xeniaprod/tmp_web and *xeniaprod* which also performs file cleanup but more importantly runs the following main job hourly.

The file */home/xeniaprod/cron/xeniaflow.sh* creates all the subsequent related products and should be referenced to understand the product creation flow.

Xenia related log files are at /home/xeniaprod/tmp and cleared nightly.

Apache user(www-data) created related temporary files are at /home/xeniaprod/tmp_web and cleared nightly.

== ObsKML ==

If you are ready to start pulling new data into your system, see
http://code.google.com/p/xenia/wiki/VMwareTest#Adding_a_new_ObsKML_feed

----
= VMware Server =

Successfully installed VMware Server 2.0.1 on Ubuntu 8.10 

The vmware server is installed via the vmware-install.pl script and starts the services at the end of a successful install.  The vmware server maintenance ui is accessed via browser at http://localhost:8222 or secure port https://localhost:8333

If accessing the terminal console from a remote desktop via the vmware browser interface, you'll need a browser plug-in - the only one of which I found that worked was for Firefox.  See this related [http://www.google.com/support/forum/p/Chrome/thread?tid=1e2eceea54682f11&hl=en link] regarding the plug-in also.  The console may open to a black screen and you may need to gain window focus and press a key to see the display.

All connections are 'bridged',  see [http://communities.vmware.com/thread/89314 NAT versus Bridged]  Note also that you can modify the 'Configuration' settings directly by modifying the .vmx file and rebooting the image.

== Problems, workarounds ==

Had a compile error on 'vmsock' but the install said this was not critical to the usual processes.  Not having it compiled does not seem to create any noticeable issue.

One problem I ran into was that VMware server configured vmnet0 (only shows up in the process list 'ps -auxf' not via 'ifconfig' command) to eth0 and eth0 was not bridging ('x' symbol in the server maintenance ui).  Switched vmnet0 over to eth1 via the {{{/usr/bin/vmware-config.pl}}} script which did bridge correctly.

----

root@nwstwo:/usr/local/download/vmware-server-distrib/bin# vmware-config.pl 

#accept default until...
{{{
The following virtual networks have been defined:

. vmnet0 is bridged to eth0

Do you wish to make any changes to the current virtual networks settings? 
(yes/no) [no] yes

Which virtual network do you wish to configure? (0-254) 0

The network vmnet0 has been reserved for a bridged network.  You may change it,
but it is highly recommended that you use it as a bridged network.  Are you 
sure you want to modify it? (yes/no) [no] yes

What type of virtual network do you wish to set vmnet0? 
(bridged,hostonly,nat,none) [bridged] 

Configuring a bridged network for vmnet0.

Please specify a name for this network. 
[Bridged] 

Your computer has multiple ethernet network interfaces available: eth1, eth0. 
Which one do you want to bridge to vmnet0? [eth0] eth1

The following virtual networks have been defined:

. vmnet0 is bridged to eth1

Do you wish to make additional changes to the current virtual networks 
settings? (yes/no) [yes] no
}}}
...
accept defaults

----
from http://communities.vmware.com/thread/113990

There's no vmnet0 device.
To check if eth0 is bridged to vmnet0 check the output of <br/>
{{{ps ax | grep bridge}}}

it should be similar to <br/>
{{{3175 ?        S      0:00 /usr/bin/vmnet-bridge -d /var/run/vmnet-bridge-0.pid /dev/vmnet0 eth0}}}
----
also ran into the following error/fix when trying to restart the network

{{{SIOCADDRT: File exists}}}

from http://techandit.com/?p=145

{{{
A common tactic used to clone a system running under VMWare, is to simply shut down the virtual server, make a copy of the files that form the virtual server, and register the copy with VMWare and boot the server, without networking and reconfigure the network interfaces.
However when I clone Ubuntu 7.10 systems, I always find that the network interface doesn’t exist on the cloned machine. The fix for this problem is to delete the file /etc/udev/rules.d/70-persistent-net.rules , which is responsible for mapping network device names to physical (or virtual in this case) network devices. You then need to reboot the system to allow the change to take effect. Restarting the network service isn’t enough.
I’ve also had some strange problems after trying to add persistent routes to the file /etc/network/interfaces on virtual guests, which would generate the error SIOCADDRT: File exists. Deleting the above file and restarting the system also resolves this issue.
}}}
----

Per each virtual image instance/IP address as configured in the file /etc/network/interfaces, make sure to set your ethx (eth7,eth8,etc)  connection correctly the same as found in the 'ifconfig' listing  setting and restart via {{{/etc/init.d/networking restart}}}  See earlier notes [http://code.google.com/p/xenia/wiki/VMwareInstall#static_ip here]  The correct image IP listing should also show up in the vmware server maintenance ui.  Also you may need to run your host on a separate IP than your vmware instances so there is not competition for the IP address resolution.

vmware images can be referenced on the host machine vmware ui by placing or symbolically linking via the /var/lib/vmware/Virtual Machines folder

Saw some notes regarding ethernet optimization/mishandling issues such as to run the command {{{ethtool -K eth1 sg off rx off tx off tso off}}} but did not utilize this command.
----
= VMware ESXi =

Dan Ramage pointed me to the following article 
http://bsd.slashdot.org/story/09/06/02/0043258/When-VMware-Performanc... 
which 
points out a variety of opinions comparing various virtualization issues - 
one point that is highlighted by the opinions is the use in regards to 
vmware products of the free 'ESXi' product instead of 'vmware server', the 
main difference being that 'ESXi' runs directly on the server(bare-metal) 
and does not suffer some of the performance penalties associated with 
running on a host OS(Operating System).  I'll try the 'ESXi' install at some 
point and glad to hear any feedback in regards to running 'ESXi' instead of 
'vmware server' in regards to server virtualization. 

== Update June 19 2009 ==
Went through the VMware ESXi install process on one of the new Secoora 
servers(Dell Poweredge 2950) here this week - it was very easy and 
straightforward and proceeded the same as documented in the below 15 minute 
video of the same. 
http://vmwarevideos.govirtual.tv/vsphere-esxi-40-install-and-configure/
 
ESXi is the recommended freeware 'bare metal' server install for the vmware 
virtualization stuff.  *vSphere* is the related separate remote desktop 
client(freeware download also from the same ESXi download page) for managing the ESXi instance.  ESXi does not provide a management console *directly on the server* which means that you have to install/utilize *vSphere* to connect to and manage it.

Should have a vmware image for analysis, redundancy/sharing that captures 
most of the earlier aggregation and products scripts developed earlier for 
Secoora http://code.google.com/p/xenia/wiki/VMwareProducts and moving 
forward, still need possible redevelopment in regards to the earlier 
'screen-scraping' moved to web-services(sara and vembu's scripts) and 
Jesse's latest hourly maps as provided via the more recent database schema. 
Also have refocused the scripts back towards a Postgresql database initial 
use focus(due to multi-user/developer needs in-house between Dan and myself 
and the popularity of Xenia/postgresql within the IOOS community) and Sqlite 
more as a optional secondary or file archive purpose. 

It was the ESXi 4.0 instance(64-bit) - after signing up with a vmware user
account it will send you an email activation link with the license code.  The license code can be entered via the VSphere managment interface immediately or at the end of the 60 day evaluation (the full ESXi product I believe).

The only snafus I ran into was installing ESXi to 'Disk1' controller first,
the machine only wanted to boot off of 'Disk0' so reran with Disk0 as the
option.

Also had to work through getting the usual static IP, DNS issues
and remote port access from my desktop subnet to the ESXi server IP.  Be sure to get your netmask and default gateway settings correct in the ESXi interface - I set my netmask to 255.255.0.0 so that I could manage the server(at 129.252.37.x) from a different subnet(129.252.139.x).

Also be aware of the need to download/install the *vCenter converter* (VMware vCenter Converter Standalone 4.0.1 http://www.vmware.com/download/converter/ ) I downloaded/installed to my windows desktop and convert my earlier vmware server image to an ESXi image (the converter application supports a variety of other conversions as well).

When moving my earlier vmware image to my desktop I did run into a 2 gigabyte file size limitation with a samba mount(smbfs), which was addressed by mounting as 'cifs' instead which does not have the file size limitation

#2 GB file size limit for smbfs (use cifs) <br/>
{{{mount -t cifs -o username=xxx,password=xxx,workgroup=xxx //xxx.xxx.xxx.xxx/temp /temp}}}

After migrating/converting and powering on the vmware image, I had to assign the correct IP as detailed earlier [http://code.google.com/p/xenia/wiki/VMwareInstall#static_ip here]   The vSphere application provides a variety of system metrics and a terminal/display console link for each vmware instance.

== vCenter, vSphere image transfer/startup instructions ==

If the downloaded vmware [VMwareDownload] .vmdk file size is correct(4236256768 bytes), the next step is to get the image onto ESXi via the vCenter desktop tool.

vCenter converter - VMware vCenter Converter Standalone 4.0.1 http://www.vmware.com/download/converter/

Start the *vCenter* application (which can also be used to convert a variety of vmware products or existing windows/linux servers into vmware images)

Click 'Convert Machine' button towards top of window menu

----
On the '*Specify Source*' tab window,

'Select source type' : choose the last option 'Virtual appliance'
'Location':'File System'
and 'Browse' to the folder which contains both the .ovf file and .vmdk file (xeniavm20090713.ovf, xeniavm20090713.vmdk)

click 'Next' button, and 'Next' again through 'Appliance details' window

----
On the '*Specify Destination*' tab window

'Select destination type':'VMware Infrastructure virtual machine'
and then choose the IP address, root login/password for the ESXi server

click 'Next' button, and 'Next' again through 'Host/Resource' window(note that the image will be transferred to one of the available 'datastore's which are the ESXi servers hard drive(s).

----
On the '*View/Edit Options*' tab window

click 'Next' but note that the processor, memory and disk options can be edited here - I'm currently still using the default '1 processor, 512 MB memory' setup although it would probably be worth experimenting with '2 processor' and larger memory,etc to see if any large improvements in the image performance.

----
On the '*Ready to Complete*' tab window

click 'Finish' and the image transfer process begins and should take about an hour or less(progress meter is shown in vCenter application).

After the transfer is complete,

From the *vSphere* application, you should be able to 'see' the new vmware image available for 'Power On' under the server inventory list in the left-hand column drop-down. you should be able to 'see' the new vmware image available for 'Power On' under the server inventory list in the left-hand column drop-down.  Go ahead select the 'xeniavm20090713' image and 'power on'(the play symbol in the menu) the image.  Click the 'Summary' tab in the right-side pane after the image is powered on and choose the 'Open Console' option under the 'Commands' section to bring up a terminal session.  You should be able to login to the server as user 'xeniaprod' with password 'xeniaprod99'.

The finishing configuration part is detailed at http://code.google.com/p/xenia/wiki/VMwareInstall#static_ip (skip the sections about 'ip tables' and 'postgresql or sqlite') through the 'miscellaneous' section.

After that let the server run for a day and see that you're getting data and its generating the variety of formats/services detailed at http://code.google.com/p/xenia/wiki/VMwareProducts

== Entering vmware license key == 

To enter your ESXi license key (shown on the earlier vmware download page when logged into the vmware website with your vmware account)

from the vSphere application:

from http://communities.vmware.com/thread/220594;jsessionid=11B1C53FDBB3284777221D14AD00D6D9?tstart=0

In order to enter the serial number in your ESX4i host

Home -> Inventory -> top level (your ESXi Host)
Configuration Tab
Left-hand side - Licensed features
Edit -> Assign new key to this host -> Enter Key
Paste your key
Confirm all the rest 
Your ESXi Server is now fully licensed

Please note - you will only have the basic functionality and all the enterprise features that came with the Evaluation License are no longer valid

from http://communities.vmware.com/thread/220594;jsessionid=11B1C53FDBB3284777221D14AD00D6D9?tstart=0
